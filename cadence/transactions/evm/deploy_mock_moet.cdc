import "EVM"

/// Deploys MockMOET ERC20 token with constructor args
/// Constructor: MockERC20(string name, string symbol, uint256 initialSupply)
transaction() {
    prepare(signer: auth(Storage, SaveValue) &Account) {
        // Get or create COA with Owner authorization
        var coaRef = signer.storage.borrow<auth(EVM.Owner) &EVM.CadenceOwnedAccount>(from: /storage/evm)
        if coaRef == nil {
            let coa <- EVM.createCadenceOwnedAccount()
            signer.storage.save(<-coa, to: /storage/evm)
            coaRef = signer.storage.borrow<auth(EVM.Owner) &EVM.CadenceOwnedAccount>(from: /storage/evm)
        }
        
        let coa = coaRef!
        
        // MockERC20 bytecode with constructor args encoded
        // Constructor: ("Mock MOET", "MOET", 10000000 * 10**18)
        // Bytecode is from solidity/out/MockERC20.sol/MockERC20.json
        
        // NOTE: For now, we'll use a simplified deployment
        // Full bytecode with constructor encoding will be added once we verify basic deployment works
        
        // Minimal ERC20 for testing (simplified version)
        // This is just to prove deployment - full ERC20 with constructor args next
        let minimalERC20 = "608060405234801561001057600080fd5b50600436106100a95760003560e01c80633950935111610071578063395093511461016857806370a082311461019857806395d89b41146101c8578063a457c2d7146101e6578063a9059cbb14610216578063dd62ed3e14610246576100a9565b806306fdde03146100ae578063095ea7b3146100cc57806318160ddd146100fc57806323b872dd1461011a578063313ce5671461014a575b600080fd5b6100b6610276565b6040516100c39190610b0e565b60405180910390f35b6100e660048036038101906100e19190610bc9565b610308565b6040516100f39190610c24565b60405180910390f35b61010461032b565b6040516101119190610c4e565b60405180910390f35b610134600480360381019061012f9190610c69565b610335565b6040516101419190610c24565b60405180910390f35b610152610364565b60405161015f9190610cd8565b60405180910390f35b610182600480360381019061017d9190610bc9565b61036d565b60405161018f9190610c24565b60405180910390f35b6101b260048036038101906101ad9190610cf3565b6103a4565b6040516101bf9190610c4e565b60405180910390f35b6101d06103ec565b6040516101dd9190610b0e565b60405180910390f35b61020060048036038101906101fb9190610bc9565b61047e565b60405161020d9190610c24565b60405180910390f35b610230600480360381019061022b9190610bc9565b6104f5565b60405161023d9190610c24565b60405180910390f35b610260600480360381019061025b9190610d20565b610518565b60405161026d9190610c4e565b60405180910390f35b60606003805461028590610d8f565b80601f01602080910402602001604051908101604052809291908181526020018280546102b190610d8f565b80156102fe5780601f106102d3576101008083540402835291602001916102fe565b820191906000526020600020905b8154815290600101906020018083116102e157829003601f168201915b5050505050905090565b600080610313610592565b905061032081858561059a565b600191505092915050565b6000600254905090565b600080610340610592565b905061034d858285610763565b6103588585856107ef565b60019150509392505050565b60006012905090565b600080610378610592565b905061039981858561038a8589610518565b6103949190610def565b61059a565b600191505092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6060600480546103fb90610d8f565b80601f016020809104026020016040519081016040528092919081815260200182805461042790610d8f565b80156104745780601f1061044957610100808354040283529160200191610474565b820191906000526020600020905b81548152906001019060200180831161045757829003601f168201915b5050505050905090565b600080610489610592565b9050600061049782866105"
        
        // Parse and deploy
        var code: [UInt8] = []
        var hex = minimalERC20
        var i = 0
        while i < hex.length {
            if i + 2 <= hex.length {
                let byteStr = "0x".concat(hex.slice(from: i, upTo: i + 2))
                if let byte = UInt8.fromString(byteStr) {
                    code.append(byte)
                }
            }
            i = i + 2
        }
        
        let deployResult = coa.deploy(
            code: code,
            gasLimit: 15000000,
            value: EVM.Balance(attoflow: 0)
        )
        
        log("âœ… MockMOET deployed")
        log("   Gas used: ".concat(deployResult.gasUsed.toString()))
        log("   Status: ".concat(deployResult.status == EVM.Status.successful ? "success" : "failed"))
    }
}

