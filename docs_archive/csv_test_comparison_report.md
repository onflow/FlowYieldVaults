# CSV vs Cadence Test Values Comparison Report

## Summary
This report compares the values generated by the Python simulator (CSV files) with the expected values defined in the Cadence test files.

## Scenario 1: FLOW Price Grid
**Status: ✅ MATCHES**

### Expected Values (from `rebalance_scenario1_test.cdc`)
```cadence
let expectedYieldTokenValues: {UFix64: UFix64} = {
    0.5: 307.69230769,
    0.8: 492.30769231,
    1.0: 615.38461538,
    1.2: 738.46153846,
    1.5: 923.07692308,
    2.0: 1230.76923077,
    3.0: 1846.15384615,
    5.0: 3076.92307692
}
```

### CSV Values (`Scenario1_FLOW.csv` - YieldAfter column)
| FlowPrice | CSV YieldAfter | Expected | Difference |
|-----------|----------------|----------|------------|
| 0.5 | 307.692307692 | 307.69230769 | +0.000000002 |
| 0.8 | 492.307692308 | 492.30769231 | -0.000000002 |
| 1.0 | 615.384615385 | 615.38461538 | +0.000000005 |
| 1.2 | 738.461538462 | 738.46153846 | +0.000000002 |
| 1.5 | 923.076923077 | 923.07692308 | -0.000000003 |
| 2.0 | 1230.769230769 | 1230.76923077 | -0.000000001 |
| 3.0 | 1846.153846154 | 1846.15384615 | +0.000000004 |
| 5.0 | 3076.923076923 | 3076.92307692 | +0.000000003 |

**Result**: Values match within floating-point precision (differences in 9th decimal place)

## Scenario 2: YIELD Price Increases
**Status: ❌ DOES NOT MATCH**

### Expected Values (from `rebalance_scenario2_test.cdc`)
```cadence
let yieldPriceIncreases = [1.1, 1.2, 1.3, 1.5, 2.0, 3.0]
let expectedFlowBalance = [
    1061.53846154,
    1120.92522862,
    1178.40857368,
    1289.97388243,
    1554.58390959,
    2032.91742023
]
```

### CSV Values (`Scenario2_Instant.csv` - Collateral column)
| YieldPrice | CSV Collateral | Expected | Difference | % Difference |
|------------|----------------|----------|------------|--------------|
| 1.1 | 1061.538461539 | 1061.53846154 | -0.000000001 | ~0% |
| 1.2 | 1125.056481980 | 1120.92522862 | +4.131253360 | +0.37% |
| 1.3 | 1191.220755576 | 1178.40857368 | +12.812181896 | +1.09% |
| 1.5 | 1318.093216751 | 1289.97388243 | +28.119334321 | +2.18% |
| 2.0 | 1640.521552976 | 1554.58390959 | +85.937643386 | +5.53% |
| 3.0 | 2442.923571947 | 2032.91742023 | +410.006151717 | +20.17% |

**Result**: Significant discrepancies, increasing with yield price

## Scenario 3A: Path-Dependent (FLOW 0.8, YIELD 1.2)
**Status: ❌ DOES NOT MATCH**

### Expected Values (from `rebalance_scenario3a_test.cdc`)
```cadence
let expectedYieldTokenValues = [615.38461538, 492.30769231, 460.74950690]
let expectedFlowCollateralValues = [1000.00000000, 800.00000000, 898.46153846]
let expectedDebtValues = [615.38461538, 492.30769231, 552.89940828]
```

### CSV Values (`Scenario3_Path_A_precise.csv`)
| Step | Metric | CSV Value | Expected | Difference |
|------|--------|-----------|----------|------------|
| 1 | YieldUnits | 615.384615385 | 615.38461538 | +0.000000005 |
| 1 | Collateral | 1000.000000000 | 1000.00000000 | 0.0 |
| 1 | Debt | 615.384615385 | 615.38461538 | +0.000000005 |
| 2 | YieldUnits | 492.307692308 | 492.30769231 | -0.000000002 |
| 2 | Collateral | 800.000000000 | 800.00000000 | 0.0 |
| 2 | Debt | 492.307692308 | 492.30769231 | -0.000000002 |
| 3 | YieldUnits | 458.729783038 | 460.74950690 | -2.019723862 |
| 3 | Collateral | 878.769230770 | 898.46153846 | -19.692307690 |
| 3 | Debt | 540.781065089 | 552.89940828 | -12.118343191 |

**Result**: Step 3 shows significant discrepancies

## Analysis

1. **Scenario 1 (FLOW price changes only)**: The Python simulator matches the expected values perfectly, with only floating-point precision differences.

2. **Scenario 2 (YIELD price increases)**: The simulator shows increasing divergence from expected values as yield prices increase. This suggests a difference in how the auto-balancer or auto-borrow logic is implemented.

3. **Scenario 3A (Combined FLOW and YIELD changes)**: The third step shows significant differences, indicating the path-dependent calculations may differ between implementations.

## Possible Causes of Discrepancies

1. **Order of Operations**: The Python simulator might be applying the auto-balancer and auto-borrow operations in a different order than the Cadence implementation.

2. **Rounding/Precision**: While both use high precision, the exact rounding moments might differ.

3. **Auto-Balancer Logic**: The "sell everything above debt" logic might be interpreted differently, especially when combined with borrowing operations.

4. **Path Dependency**: The accumulation of small differences over multiple steps could lead to larger discrepancies in path-dependent scenarios.

## Scenario 3B: Path-Dependent (FLOW 1.5, YIELD 1.3)
**Status: ❌ DOES NOT MATCH**

### Expected Values (from `rebalance_scenario3b_test.cdc`)
```cadence
let expectedYieldTokenValues = [615.38461539, 923.07692308, 841.14701866]
let expectedFlowCollateralValues = [1000.0, 1500.0, 1776.92307692]
let expectedDebtValues = [615.38461539, 923.07692308, 1093.49112426]
```

### CSV Values (`Scenario3_Path_B_precise.csv`)
| Step | Metric | CSV Value | Expected | Difference |
|------|--------|-----------|----------|------------|
| 1 | YieldUnits | 615.384615385 | 615.38461539 | -0.000000005 |
| 1 | Collateral | 1000.000000000 | 1000.0 | 0.0 |
| 1 | Debt | 615.384615385 | 615.38461539 | -0.000000005 |
| 2 | YieldUnits | 923.076923077 | 923.07692308 | -0.000000003 |
| 2 | Collateral | 1500.000000000 | 1500.0 | 0.0 |
| 2 | Debt | 923.076923077 | 923.07692308 | -0.000000003 |
| 3 | YieldUnits | 965.680473373 | 841.14701866 | +124.533454713 |
| 3 | Collateral | 1915.384615385 | 1776.92307692 | +138.461538465 |
| 3 | Debt | 1178.698224852 | 1093.49112426 | +85.207100592 |

**Result**: Step 3 shows very significant discrepancies (14%+ differences)

## Analysis Summary

The Python simulator matches the expected values perfectly for Scenario 1 (FLOW price changes only), but shows significant discrepancies in scenarios involving YIELD price changes (Scenarios 2, 3A, 3B). The discrepancies grow with:

1. **Higher yield prices**: In Scenario 2, the error grows from 0% at yield price 1.1 to 20% at yield price 3.0
2. **Path-dependent operations**: Scenarios 3A and 3B show large errors in the third step after combined FLOW and YIELD changes

## Key Findings

1. **Scenario 1**: ✅ Perfect match (only FLOW price changes, no yield price changes)
2. **Scenario 2**: ❌ Growing errors with yield price increases
3. **Scenario 3A/3B**: ❌ Large errors after yield price changes

The pattern suggests the issue is specifically with how the auto-balancer handles yield token sales when yield prices increase, possibly in combination with the auto-borrow logic.

## Root Cause Analysis

After examining the Cadence implementation, the key difference has been identified:

### Python Simulator Logic (Incorrect)
- Auto-Balancer: "Sell everything above **debt**"
- This was based on the user prompt but doesn't match the actual implementation

### Actual Cadence Implementation
- Auto-Balancer maintains a **"value of deposits"** baseline
- Uses thresholds: lower=0.95, upper=1.05 (from `TracerStrategyComposer`)
- When current value > 1.05 × value_of_deposits: rebalance the **excess above value_of_deposits**
- NOT "everything above debt"

### Key Code Reference
From `lib/DeFiActions/cadence/contracts/interfaces/DeFiActions.cdc`:
```cadence
// Line 574: Calculate difference from historical value of deposits
var valueDiff: UFix64 = currentValue < self._valueOfDeposits ? 
    self._valueOfDeposits - currentValue : currentValue - self._valueOfDeposits

// Line 593: Rebalance back down to baseline (value_of_deposits)
// NOT to debt level
```

## Why This Matters

1. **Scenario 1 Works**: Because it only changes FLOW prices, no yield tokens are sold, so the auto-balancer logic difference doesn't matter
2. **Scenarios 2 & 3 Fail**: When yield prices increase, the auto-balancer behavior diverges significantly:
   - Python: Sells all yield tokens above debt amount
   - Cadence: Only sells yield tokens when value exceeds 105% of deposits, and only sells the excess above deposits

## Recommendations

1. **Fix Python Simulator**: Update the auto-balancer logic to:
   - Track value of deposits separately from debt
   - Implement the 5% threshold (upper=1.05)
   - Rebalance to value_of_deposits baseline, not debt
2. **Verify Threshold Values**: Confirm if all strategies use 0.95/1.05 thresholds or if these vary
3. **Reference Google Sheets**: Access the reference calculations to ensure complete alignment